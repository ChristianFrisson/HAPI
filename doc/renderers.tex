
\chapter {Haptics rendering algorithms}
In HAPI a haptics rendering algorithm (or haptics renderer) is a class
responsible for determining the forces and torque to render depending
on position and other data from the haptics device and all the shapes
the user has added to the scene. 

\section{Proxy based rendering}
All the algorithms supported by HAPI (both internally implemented and
external libraries such as OpenHaptics and Chai3D) use some variant of
proxy based haptics rendering. The proxy based rendering technique
involves having a virtual representation of the haptics device called
the proxy. The proxy follows the position of the haptics device, but
is not allowed to penetrate any surface. This means that when a
geometry is touched the proxy stays on the surface of the object, even
if the haptics device actually has penetrated the surface. Forces are
then generated to bring the haptics device out of the surface, towards
the proxy, and usally some kind of spring force between the proxy and
haptics device is used. When the user moves the haptics device inside
the object the proxy follows the movement, but on the surface. How the
proxy follows determines how the structure of the surface will
feel. For example, if the proxy is always moved to a local minimum on
the distance to the surface, the surface will feel completely smooth,
but if the proxy is dragging behind you can get friction effects. In
HAPI the user can control both the forces generated and the movement
of the proxy.

\begin{figure} 
  \centering 
  \includegraphics{images/proxyfinger.pdf}
  \caption{The proxy stays on the surface when the haptics
  device (probe) penetrates the surface. The resulting force is most
  commonly a spring force pushing the probe back towards the proxy.} 
  \label{Proxy-probe} 
\end{figure}



In the algorithms in HAPI the geometry of the proxy is either a point
or a sphere. The problem with point proxies is that it can fall
through small gaps in the geometry and makes it very hard to be able
to touch small, thin objects. Sphere problems... 

\section{Available algorithms}
There are four algorithms available in HAPI, where two are internally
implemented and two uses external haptics libraries. We will list them
and point out their uses, advantages/disadvantages etc.

\subsection{God-Object algorithm}
The god-object algorithm is based on the God-object paper( reference)
by .... It uses a point proxy .
- Point proxy
- User defined surfaces

\subsection{Ruspini algorithm}
The ruspini renderer is based on the algorithm presented by Ruspini in
(reference). It uses a sphere proxy.
- Sphere proxy
- User defined surfaces


\subsection{Chai3D}
- Sphere proxy(but not good)
- No user defined surfaces
- No magnetic surfaces

\subsection{OpenHaptics}
- Point based
- Only devices from SensAble
- No user defined surfaces

\section{Surfaces}
(TODO)
A surface object in HAPI is an object that defines the haptic properties of a geometric shape, such as stiffness and friction. It is responsible for generating forces at a local contact point on a shape. The base class of all such objects is HAPISurfaceObject and there are several surfaces available in HAPI. They are: 

(TODO Change to FrictionSurface!! take away bumpMap??)
\begin{itemize}
\item FrictionSurface - Allows the user to set stiffness, damping, static friction and dynamic friction.
\item MagneticSurface - Surface pulls the haptics device towards the
  surface when within a user specified distance. 
\item DepthMapSurface - Use a texture to define the height 
\item StiffnessFunctionSurface - Use a generic function to generate
  the normal force. The function takes the penetration depth as input
  and returns the corresponding force. 
\end{itemize}

There are also some surfaces specific for the OpenHaptics and Chai3D
libraries which allows the user to set the parameters available in
those libraries directly. They are:
\begin{itemize}
\item OpenHapticsSurface - Has all the parameters available in
  MagneticSurface, i.e. stiffness, staticFriction, etc, but instead of
  specifying them in the HAPI way in absolute units, they are all
  specified as a value between 0 and 1. A value of 0 for the stiffness
  means no stiffness at all and a value of 1 means the maximum
  stiffness the device can handle.
\item Chai3DSurface?? Don't know yet if it has any special parameters.
\end{itemize}

\subsection{User defined surfaces}

In addition to using the already defined surfaces HAPI provides an interface to develop custom surfaces. This gives the user full control over the forces generated when in contact with a surface. The base class for all surface classes is HAPISurfaceObject and this is the class to inherit from when creating new surfaces. The surface object is responsible for two things. 


\subsubsection{Moving the proxy}
The movement of the proxy is often used to control the feeling of an abject when moving across the surface, e.g. if the surface should feel smooth or rough. Letting the proxy move along the contact plane as to minimise the distance between proxy and probe will create a totally smooth surface since the forces will always just be normal forces and no tangential forces. Letting the proxy lag behind in different ways can be used to create different friction-like effects and not letting it move at all will mean that you will not be able to move away from the first point of contact of the surface (unless you lift the probe out of the surface). The proxy movement is a 2D movement along the xz-plane of the local contact coordinate system. 

When defining a new surface the virtual function getProxyMovement( ContactInfo \&ci ) in HAPISurfaceObject is used to define the proxy movement. The user should call the ci.setLocalProxyMovement( Vec2f pm ) function here to set the proxy movement. The rendering system will try to move the proxy according to the specified movement but might be stopped by colliding with other geomtries along the path to the new position. The proxy will then stay at this collision point instead of moving all the way to the specified position.

\begin{figure} 
  \centering 
  \includegraphics{images/surface.pdf}
  \caption{Local surface contact. Always moving the proxy to the dashed position(i.e. minimise the distance between proxy and probe) will give a surface without any friction.}
  \label{proxy movement} 
\end{figure}

\subsubsection{Calculating an interaction force}
After the new position of the proxy has been calculated, the interaction force with the surface has to be determined. For the most common surface types this is usually a linear spring force pulling the device back towards the proxy. It is however totally up to the user to define the force profile of the interaction to model e.g. button clicks and other non-linear behaviour. To have the most stable force feedback it is recommended that the direction of the force towards the proxy however.  
The interaction force(and possible torque) in a new surface is determined by defining the virtual function getForces( ContactInfo \&ci ) by calling the setGlobalForce or setLocalForce functions in the ci object. 

\subsection{The ContactInfo object}
When calculating the proxy movement and the interaction force the user has access to a ContactInfo object. This object contains information about the surface contact that can be used in the calculations. It is also the object in which to return the calculated forces and proxy movement. The most commonly used values from the object are:

\begin{itemize}
\item Contact point origin(proxy position) (add proxyPosition functions)?.
\item Probe position.
\item Probe velocity(not implemented).
\item Texture coordinate of contact.
\item The haptics device that made the contact.
\item The haptic shape the contact is made on.
\end{itemize}


All positions can be obtained in either the global coordinate system or
in a local contact coordinate system. The local coordinate system is constructed with the proxy position as the origin, the contact normal as the y-axis and and two arbitrary perpendicular axis in the plane as x and z-axis. This means that e.g. the penetration depth is the same as -y in the local coordinate system. 

\begin{figure} 
  \centering 
  \includegraphics{images/coordsystems.pdf}
  \caption{Local and global coordinate system. The local coordinate system is constructed with the proxy position as the origin, the contact normal as the y-axis and and two arbitrary perpendicular axis in the plane as x and z-axis.}
  \label{coordsystems} 
\end{figure}


\begin{itemize}
\item Force - setGlobalForce/setLocalForce
\item Torque - setGlobalForce/setLocalForce
\item Proxy movement - setLocalProxyMovement
\end{itemize}

See the Doxygen documentation for a full listing of the functions available.

\subsection{Example surface}
Following is an example of an implementation of a surface with no friction and a linear spring force for the penetration of the surface.   

\input{examples/surface_example_h}
